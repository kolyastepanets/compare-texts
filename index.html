<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Comparison</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1 class="compare-texts">Compare Texts</h1>
    <div class="button-container">
      <button onclick="compareTexts()">Compare</button>
    </div>
    <div id="message-div"></div>
    <div class="text-container">
      <div id="text1" class="editable" contenteditable="true" data-placeholder-1="Insert a version of the text here."></div>
      <a id="arrow-down" class="arrow-down">&#x2193;</a>
      <div id="text2" class="editable" contenteditable="true" data-placeholder-2="Insert another version of the text here."></div>
    </div>
    <div id="original-texts-container" class="original-texts-container" style="display: none;">
      <textarea id="original-text1" class="original-text" readonly></textarea>
      <div class="spacer"></div>
      <textarea id="original-text2" class="original-text" readonly></textarea>
    </div>
  </div>

  <script>
    document.getElementById('text1').addEventListener('paste', function(e) {
      e.preventDefault();
      var text = (e.clipboardData || window.clipboardData).getData('text');
      document.execCommand('insertText', false, text);
    });

    document.getElementById('text2').addEventListener('paste', function(e) {
      e.preventDefault();
      var text = (e.clipboardData || window.clipboardData).getData('text');
      document.execCommand('insertText', false, text);
    });

    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function highlightDifferences(line1, line2) {
      function findLCS(s1, s2) {
        const lengths = Array(s1.length + 1).fill(null).map(() => Array(s2.length + 1).fill(0));
        for (let i = 1; i <= s1.length; i++) {
          for (let j = 1; j <= s2.length; j++) {
            if (s1[i - 1] === s2[j - 1]) {
              lengths[i][j] = lengths[i - 1][j - 1] + 1;
            } else {
              lengths[i][j] = Math.max(lengths[i - 1][j], lengths[i][j - 1]);
            }
          }
        }
        let lcs = '';
        let x = s1.length;
        let y = s2.length;
        while (x !== 0 && y !== 0) {
          if (lengths[x][y] === lengths[x - 1][y]) {
            x--;
          } else if (lengths[x][y] === lengths[x][y - 1]) {
            y--;
          } else {
            lcs = s1[x - 1] + lcs;
            x--;
            y--;
          }
        }
        return lcs;
      }

      const lcs = findLCS(line1, line2);
      let highlightedLine1 = '';
      let highlightedLine2 = '';
      let i = 0, j = 0, k = 0;

      while (i < line1.length || j < line2.length) {
        if (k < lcs.length && line1[i] === lcs[k] && line2[j] === lcs[k]) {
          highlightedLine1 += escapeHtml(line1[i]);
          highlightedLine2 += escapeHtml(line2[j]);
          i++;
          j++;
          k++;
        } else {
          if (i < line1.length && (k >= lcs.length || line1[i] !== lcs[k])) {
            highlightedLine1 += `<span class="highlight">${escapeHtml(line1[i])}</span>`;
            i++;
          }
          if (j < line2.length && (k >= lcs.length || line2[j] !== lcs[k])) {
            highlightedLine2 += `<span class="highlight">${escapeHtml(line2[j])}</span>`;
            j++;
          }
        }
      }

      return { highlightedLine1, highlightedLine2 };
    }

    function compareTexts() {
        const text1Div = document.getElementById('text1');
        const text2Div = document.getElementById('text2');
        const messageDiv = document.getElementById('message-div');
        const text1 = text1Div.innerText;
        const text2 = text2Div.innerText;

        // Store original texts in the inputs
        document.getElementById('original-text1').value = text1;
        document.getElementById('original-text2').value = text2;
        document.getElementById('original-texts-container').style.display = 'flex';

        const lines1 = text1.split('\n');
        const lines2 = text2.split('\n');
        const newLines1 = []
        const newLines2 = []

        let highlightedText1 = '';
        let highlightedText2 = '';
        let isDifferent = false;
        let firstDifferenceLine = null;
        const maxLength = Math.max(lines1.length, lines2.length);

        const hash1 = {};
        const hash2 = {};
        for (let i = 0; i < lines1.length; i++) {
          hash1[lines1[i]] = i;
        }
        for (let i = 0; i < lines2.length; i++) {
          hash2[lines2[i]] = i;
        }

        if (lines1.length > lines2.length) {
          for (let i = 0; i < lines1.length; i++) {
            newLines1.push(lines1[i]);

            if (typeof hash2[lines1[i]] === 'number') {
              newLines2.push(lines1[i]);
            } else {
              newLines2.push('');
            }
          }
        }
        if (lines1.length < lines2.length) {
          for (let i = 0; i < lines2.length; i++) {
            newLines2.push(lines2[i]);

            if (typeof hash1[lines2[i]] === 'number') {
              newLines1.push(lines2[i]);
            } else {
              newLines1.push('');
            }
          }
        }
        if (lines1.length === lines2.length) {
          for (let i = 0; i < lines1.length; i++) {
            newLines1.push(lines1[i]);
            newLines2.push(lines2[i]);
          }
        }

        for (let i = 0; i < maxLength; i++) {
          const line1 = newLines1[i] || '';
          const line2 = newLines2[i] || '';
          const lineNumber = i + 1; // Line number starts from 1

          if (line1 !== line2) {
            isDifferent = true;
            if (firstDifferenceLine === null) {
              firstDifferenceLine = lineNumber;
            }
            const { highlightedLine1, highlightedLine2 } = highlightDifferences(line1, line2);
            highlightedText1 += `<span id="line-${lineNumber}" class="highlight">${lineNumber}</span>` + ': ';
            highlightedText1 += `<span> ${highlightedLine1 + '\n'}</span>`
            highlightedText2 += `<span id="line-${lineNumber}" class="highlight">${lineNumber}</span>` + ': ';
            highlightedText2 += `<span> ${highlightedLine2 + '\n'}</span>`
          } else {
            highlightedText1 += lineNumber + ': ' + escapeHtml(line1) + '\n';
            highlightedText2 += lineNumber + ': ' + escapeHtml(line2) + '\n';
          }
        }

        text1Div.innerHTML = highlightedText1.replace(/\n/g, '<br>');
        text2Div.innerHTML = highlightedText2.replace(/\n/g, '<br>');

        text1Div.innerHTML = highlightedText1.replace(/\n/g, '<br>');
        text2Div.innerHTML = highlightedText2.replace(/\n/g, '<br>');

        console.log(text1Div.clientHeight)
        console.log(text1Div.scrollHeight)
        text1Div.style.height = text1Div.scrollHeight + 'px';
        text2Div.style.height = text2Div.scrollHeight + 'px';

        text1Div.contentEditable = 'false';
        text2Div.contentEditable = 'false';

        if (isDifferent) {
          document.getElementById('arrow-down').style.color = '#4141c9'; // Show the arrow
          document.getElementById('arrow-down').addEventListener('click', function() {
            const firstDifferenceElement = document.getElementById(`line-${firstDifferenceLine}`);
            if (firstDifferenceElement) {
              firstDifferenceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        } else {
          messageDiv.textContent = 'The texts are the same.';
        }
      }
  </script>

</body>
</html>
